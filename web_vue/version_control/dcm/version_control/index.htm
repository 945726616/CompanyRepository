<!-- version v9.5.1.2205101032 -->
<!-- 版本号 v9.5.1.2205101032 -->
<html>
<head>
  <meta http-equiv="content-type" content="text/html" charset="utf-8">
  <script src="./host_choose.js"></script>
  <script type="text/javascript">
    if (location.href.indexOf("f=app") > -1) {
      document.write("<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'/>")
    }
    var m_hostname
    var m_httpsport
    var m_httpsappid
    var m_https
    var m_htm
    var browserHref
    var web_url = window.location.href
    var ispicture = 0
    var host_choose_item // 域名判断选择项
    var iframeData // 从iframe中获取的传递值 传递的内容示例: {signalServer: "http://45.113.201.4:7080", host: "www.vimtag.com"}
    function GetUrlParms() { // 参数截取函数
      var args, query, pairs
      args = new Object()
      query = location.search.substring(1)
      pairs = query.split("&")
      for (var i = 0; i < pairs.length; i++) {
        var pos = pairs[i].indexOf('=')
        if (pos === -1) {
          continue
        }
        var argname = pairs[i].substring(0, pos)
        var value = pairs[i].substring(pos + 1)
        args[argname] = unescape(value)
      }
      return args
    }
    function start() {
      var s, pageTitle, tp = null, request, oem_domain
      window.addEventListener("message", function (e) { // 获取入口文件处取得的信令服务器地址
        iframeData = e.data
        console.log(iframeData, 'childPage get parentPage data') // 在子页面中获取到父页面发送的数据信息
        m_hostname = iframeData.host // 赋值m_hostname
        browserHref = iframeData.browserHref // 赋值获取到的浏览器显示的地址
        cmipcgwGetData = iframeData.cmipcgwGetData // 赋值获取到的cmipcgw信息
        console.log(typeof(browserHref), 'browserHref Type')
        if (browserHref.indexOf('device') > 0) { // 地址链接中是否包含device
          m_hostname += '/device'
        }
        console.log(m_hostname, 'm_hostname')
        for (host_item in host_choose) { // 从Json文件中对比已经注册了的域名并获取展示在标签页上的title名
          if (host_item === m_hostname || (host_item.substring(0, 3) !== "www" && host_item === m_hostname)) {
            pageTitle = host_choose[host_item].title // 存储选中的标题值
            host_choose_item = host_item // 存储选中的item
          }
        }
        if (pageTitle) { // 赋值title名, 列表中含有的正常设置 未含有的统一设置成MIPC 使用postFatherMessage方法进行跨域传输
          postFatherMessage(pageTitle)
        } else {
          postFatherMessage("MIPC")
        }
        console.log('host_choose_item', host_choose_item, pageTitle, host_choose_item)
        // 客户端vimtag/ebitcam特殊判断
        if ((host_choose_item === 'www.vimtag.com' || host_choose_item === 'www.ebitcam.com') && window.fujikam === 'fujikam') {
          host_choose_item += '/device'
        }
        if (host_choose_item && host_choose[host_choose_item].address) { // 访问服务器固定地址文件
          if (iframeData.cmipcgwGetData.myloc === 'US') { // 地区为美国时跳转至
            document.body.innerHTML = "<iframe id='main_ifr' src='" + window.location.protocol + "//us.vimtag.com'></iframe>"
          } else {
            document.body.innerHTML = "<iframe id='main_ifr' src='" + iframeData.signalServer + host_choose[host_choose_item].address + "'></iframe>"
          }
        }else { // 访问版本文件内容
          get_version()
        }
      }, false)
    }

    function get_version() { // 获取版本信息
      // 拼接版本中关键参数 host_choose_item, host_choose[host_choose_item].brand !== undefined, host_choose[host_choose_item].brand, browserHref.split('.')[1]
      var version_request = '/dcm/version/rls_website/' + ((host_choose_item && host_choose[host_choose_item].brand !== undefined) ? host_choose[host_choose_item].brand : window.location.href.split('.')[1]) + '-pkgs.rls.json'
      var httpRequest = new XMLHttpRequest() // 第一步：建立所需的对象
      httpRequest.open('GET', iframeData.signalServer + version_request, true) // 第二步：打开连接  将请求参数写在url中
      httpRequest.send()//第三步：发送请求  将请求参数写在URL中
      // 接口请求完成后的返回值处理
      httpRequest.onreadystatechange = function () {
        if (httpRequest.readyState === 4 && httpRequest.status === 200) {
          var json = httpRequest.responseText // 获取到json字符串，还需解析
          json = JSON.parse(json)
          var version_number
          var version_pub = json.pkgsRls.website.pub
          console.log('get version rls data', version_pub, host_choose[host_choose_item], host_choose, host_choose_item) // 获取版本信息接口请求完成后的返回值
          for (var index = 0; index < version_pub.length; index++) {
            if (host_choose[host_choose_item].versionType === 'test' && version_pub[index].status === 'test') { // 测试版版本号
              version_number = version_pub[index].ver
            } else if (host_choose[host_choose_item].versionType === 'debug' && version_pub[index].status === 'debug') { // debug版版本号
              version_number = version_pub[index].ver
            } else if (host_choose[host_choose_item].versionType === 'main' && version_pub[index].status === 'main') { // 正式版版本号
              version_number = version_pub[index].ver
            }
          }
          console.log(version_number, 'final choice the version number') // 最终选择的版本号信息
          document.body.innerHTML = "<iframe id='main_ifr' src='" + iframeData.signalServer + "/dcm/version/repo/website/pkg-website-" + version_number + "/index.html?m=" + host_choose[host_choose_item].brand + "'></iframe>"
        }
      }
    }

    function postFatherMessage (data) { // 调用向父页面发送信息方法,其中数据为title
      console.log('postMessage to parentPage', data) // 向父页面发送的标题数据
      var info = {
        pageTitle: data
      }
      window.parent.postMessage(info, '*')
    }

  </script>

  <style type="text/css">
    html,
    body,
    #iframe_div,
    iframe {
      background: #fff;
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      /*overflow:hidden; */
      position: relative;
      border: 0;
    }
  </style>
  <title></title>
</head>

<body onload="start()">
</body>

</html>